os: osx
osx_image: xcode7.1 ## `xcode7.1` -> OS X 10.10 - [ref](https://docs.travis-ci.com/user/osx-ci-environment#OS-X-Version). Avoid `xcode7` as it looked like stopping job for no reason, and it appears to have been unreliable also for [at least another user](https://github.com/travis-ci/travis-ci/issues/5925).
language: c
before_install:
  ## Debug
  - uname -a
  - printenv
  ## [P* jobs] Debug
  - case $JOB in T) ;; P|PA|PAO|PO) ls -la ~;; B) ;; esac
install:
  ## [T job] Make job precondition: `bats` in PATH
  - case $JOB in T) brew install bats;; P|PA|PAO|PO) ;; B) ;; esac
  ## [P* jobs] Make job precondition: no `brew` or `brew-cask` in PATH
  - command -v brew
  - if [ $(command -v brew) != "/usr/local/bin/brew" ]; then exit 1; fi
  - brew ls | fgrep brew-cask
  - ci.d/exit_if_in_path brew-cask
  - echo $PATH
  - if [ $(echo "$PATH" | grep -c ':/usr/local/bin:') -ne 1 ]; then exit 1; fi
  - case $JOB in T) ;; P|PA|PAO|PO) export PATH=$(echo "$PATH" | sed "s|/usr/local/bin:||");; B) ;; esac
  - echo $PATH
script:
  ## [P* jobs] Check job precondition: no `brew` or `brew-cask` in PATH
  - case $JOB in T) ;; P|PA|PAO|PO) ci.d/exit_if_in_path brew;; B) ;; esac
  - case $JOB in T) ;; P|PA|PAO|PO) ci.d/exit_if_in_path brew-cask;; B) ;; esac
  ## [P* jobs] Debug - brew caches
  - ls -la /Library/Caches || true
  - ls -la ~/Library/Caches || true
  - ls -la /Library/Caches/Homebrew || true
  - ls -la ~/Library/Caches/Homebrew || true
  ## [T job] Main
  - case $JOB in T) bats tests/;; P|PA|PAO|PO) ;; B) esac
  ## [P* jobs] Main
  - case $JOB in T) ;; P|PA|PAO|PO) mkdir ~/sandbox;; B) ;; esac
  - case $JOB in T) ;; P|PA|PAO|PO) travis_wait 45 bin/provision_osx ~/sandbox "$BREW_INSTALL";; B) ;; esac
  - case $JOB in T) ;; P) ;; PA|PAO) sbin/provision_osx_as_admin;; PO) ;; B) ;; esac
  - case $JOB in T) ;; P) ;; PA) ;; PAO|PO) travis_wait 45 bin/provision_osx_otp "$OTP_GIT_BUILD_IDS";; B) ;; esac
  - case $JOB in T) ;; P|PA|PAO|PO) ;; B) HOMEBREW_EDITOR="curl https://raw.githubusercontent.com/lucafavatella/homebrew-core/a24454e/Formula/ansible.rb >" brew edit --force ansible;; esac
  - case $JOB in T) ;; P|PA|PAO|PO) ;; B) brew cat ansible;; esac
  - case $JOB in T) ;; P|PA|PAO|PO) ;; B) brew install --build-bottle ansible;; esac
  - case $JOB in T) ;; P|PA|PAO|PO) ;; B) brew bottle --verbose ansible;; esac
  - case $JOB in T) ;; P|PA|PAO|PO) ;; B) brew test ansible;; esac
  - case $JOB in T) ;; P|PA|PAO|PO) ;; B) brew audit ansible;; esac
after_script:
  ## [P* jobs] Debug
  - case $JOB in T) ;; P|PA|PAO|PO) ls -la ~;; B) ;; esac
  - case $JOB in T) ;; P|PA|PAO|PO) ls -la ~/sandbox;; B) ;; esac
notifications:
  email: false
matrix:
  allow_failures:
    - env: JOB=P BREW_INSTALL=
    - env: JOB=PA BREW_INSTALL=
    - env: JOB=PAO BREW_INSTALL=
    - env: JOB=PO BREW_INSTALL="ci.d/brew_install_otp"
    - env: JOB=PO BREW_INSTALL="ci.d/brew_install_otp" OTP_GIT_BUILD_IDS="git-7979f72-all-options-but-hipe-and-odbc"
  fast_finish: true
env:
  # - JOB=T
  # - JOB=P BREW_INSTALL=true
  # - JOB=P BREW_INSTALL=
  # - JOB=PA BREW_INSTALL=
  # - JOB=PAO BREW_INSTALL=
  # - JOB=PO BREW_INSTALL="ci.d/brew_install_otp" ## Out-of-process OTP installation without `javac`.
  # - JOB=PO BREW_INSTALL="ci.d/brew_install_otp" OTP_GIT_BUILD_IDS="OTP-18.3.3" ## Out-of-process OTP installation without `javac`.
  # - JOB=PO BREW_INSTALL="ci.d/brew_install_otp" OTP_GIT_BUILD_IDS="git-7979f72-all-options-but-hipe-and-odbc" ## Out-of-process OTP installation without `javac`.
  - JOB=B

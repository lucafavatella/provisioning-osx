#!/bin/sh

## TODO Test.

## XXX This script relies on the `android` command but [`android` "is
## no longer
## supported"](https://developer.android.com/studio/tools/help/android.html).

yes() {
    until false; do sleep "${2:?}"; echo "${1:?}"; done
}

ensure_sdk_components_installed() {
    android update sdk --no-ui --all --filter "${1:?}"
}

## TODO Ensure i.e. idempotent.
create_avd() {
    android create avd --force -n "${1:?}" -t "${2:?}" --abi "${3:?}"
}

## Refs:
## * https://docs.travis-ci.com/user/languages/android/
## * https://developer.android.com/about/dashboards/index.html
FILTER_SDK=tools,platform-tools,build-tools-25.0.0,doc-24,android-24,android-15,source-24,source-15,extra-android-m2repository ## Ref `android list sdk --no-ui --extended`.
FILTER_SDK_SYS_IMG=sys-img-arm64-v8a-android-24,sys-img-armeabi-v7a-android-24,sys-img-x86_64-android-24,sys-img-x86-android-24 ## Ref `android list sdk --no-ui --extended --all`.
FILTER=${FILTER_SDK:?},${FILTER_SDK_SYS_IMG:?}

## Refs:
## * [The problem with yes is that it floods stdout with `'y'` ... It will "pollute" stdout and the script will fail complaining about incorrect input.](http://stackoverflow.com/questions/17963508/how-to-install-android-sdk-build-tools-on-the-command-line/31900427#31900427)
## * http://stackoverflow.com/questions/4681697/is-there-a-way-to-automate-the-android-sdk-installation/21910110#21910110
## * https://github.com/makinacorpus/android-archetypes/wiki/Getting-started%3A-Building-Android-apps-with-Jenkins-CI
yes y 5 | ensure_sdk_components_installed ${FILTER:?}

echo no | create_avd test android-24 armeabi-v7a ## Ref https://docs.travis-ci.com/user/languages/android/

#!/bin/sh

set -e

epoch_s_utc() {
    date +%s
}

tic() {
    tic_time=$(epoch_s_utc) ## Non-local variable.
}

toc() {
    echo $(($(epoch_s_utc) - tic_time))
    unset tic_time
}

log() {
    echo "[$(basename "$0")] ${1:?}"
}

log_e() {
    log "${1:?}" >&2
}

log_start() {
    log "[${1:?}] ${2:?}"
    tic
}

log_end() {
    log "[${1:?}] Took $(toc) second(s)."
}

ROOT_DIR="$(cd "$(dirname "$0")"/.. && pwd)"

HOME_PREFIX="${1:-${HOME}}" ## Overridden for testing.
BREW_INSTALL="${2:-${ROOT_DIR}/libexec/brew_install}" ## Overridden for testing.

"${ROOT_DIR}"/bin/poke_git

log_start "Homebrew" "Ensuring software is installed..."
## Run `brew update` twice. Ref https://github.com/Homebrew/brew/blob/e098c37dc3734dbe097ed9804a3a88737ff71add/CONTRIBUTING.md#report-a-bug
"${ROOT_DIR}"/bin/brew update \
    && "${ROOT_DIR}"/bin/brew update \
    && "${ROOT_DIR}"/bin/brew upgrade \
    && "${ROOT_DIR}"/bin/brew cask upgrade \
    && "${ROOT_DIR}"/bin/brew cask outdated --greedy \
    && log_e "You should manually run 'brew cask upgrade --greedy' of any Homebrew Casks you deem requiring upgrade." ## Ref https://github.com/Homebrew/homebrew-cask/blob/50036e7314a2496ad4e0049d705d027bb606dfd6/USAGE.md#updatingupgrading-casks
"${ROOT_DIR}"/bin/ush -c -v "export PATH=\"${ROOT_DIR}/bin:\${PATH}\" && { ${BREW_INSTALL}
}"
"${ROOT_DIR}"/bin/brew cleanup -s
log_end "Homebrew"

log_start "home" "Setup home..."
"${ROOT_DIR}/libexec/setup_home" "$ROOT_DIR" "$HOME_PREFIX"
log_end "home"

log_e "Consider running '${ROOT_DIR}/sbin/provision_osx_as_admin'"

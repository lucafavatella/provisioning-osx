#!/bin/sh

## Copyright (C) 2015 Luca Favatella <slackydeb@gmail.com>

## Run the commands read from the specified string in a shell with
## minimal environment, relying on the env command in the PATH.
##
## The minimal environment is /etc/profile (ref Bash man page, section
## "INVOCATION") and information added by the login utility (ref man
## page of login).

print_usage() {
    echo "usage: ush [-v] [-p PATH_PREFIX_W_TRAILING_COLON] string" >&2
}

is_valid_path_prefix() {
    [ ${#1} -ge 2 ] && [ ${1:0:1} != ":" ] && [ ${1: -1:1} = ":" ] ## At least two chars long, first char is not ':', last char is ':'.
}

VFlag=
PFlag=
PathPrefix=
while getopts vp: name; do
    case $name in
        v)
            test -z "$VFlag" || { print_usage; exit 64; }
            VFlag=true;;
        p)
            test -z "$PFlag" || { print_usage; exit 64; }
            PFlag=true
            is_valid_path_prefix "$OPTARG" || { print_usage; exit 64; }
            PathPrefix="${OPTARG:?}";;
        '?')
            print_usage
            exit 64
    esac
done
shift $((${OPTIND:?} - 1)) || exit 71

test -z "${VFlag?}" && VFlag=false

[ $# -eq 1 ] || { print_usage; exit 64; }

C0="${1?}"

C1=". /etc/profile; export PATH=\"${PathPrefix?}\${PATH}\"; ${C0?}"
${VFlag:?} && echo "${C1:?}" >&2
exec env -i HOME="$HOME" TERM="$TERM" sh -c "${C1:?}"

---
- hosts: localhost
  vars:
    kerl_build_dir: "~/.kerl/builds" ## HACK Assumption: `KERL_BUILD_DIR` not changed in `~/.kerlrc`
    install_dir: "{{ home_prefix }}/dev/kerl/installations"
    ##
    otp_git_url: "https://github.com/erlang/otp.git"
    cflags_osx: "-I{{ openssl_prefix }}/include -I{{ wxmac_prefix }}/include"
    ##
    ## (2014 Jun) `--enable-lock-counter` looks enough for supporting
    ## `lcnt` application.
    ##
    ## (2ea950f) `--enable-lock-checking --enable-lock-counter
    ## --enable-fp-exceptions --with-microstate-accounting` are
    ## erts-only.
    ##
    ## (2c2c82d) The `wx` application needs the Apple compiler for
    ## using the Cocoa bits of Objective-C, but Xcode 7.0 supports
    ## only the `address` sanitizer - not the `undefined` (behaviour)
    ## one.  Options:
    ## * Stick to Apple compiler (preferred option);
    ## ** Pros:
    ## *** Build `wx`.
    ## ** Cons:
    ## *** Disable `undefined` sanitizer for all OTP.
    ## * Use custom compiler e.g. gcc from Homebrew (with `CC=gcc-5`
    ##   and `CXX=g++-5`).
    ## ** Pros:
    ## *** Enable `undefined` sanitizer for all OTP (but `wx`).
    ## ** Cons:
    ## *** Worse user experience (slower, more output) for many
    ##     harmless undefined behaviours;
    ## *** Do not build `wx` (using
    ##    `KERL_CONFIGURE_DISABLE_APPLICATIONS="wx"`).
    ##
    ## (9e1cf7d) The `odbc` application looks for iODBC, that is not
    ## easy to use (ref http://bugs.erlang.org/browse/ERL-121 ) and in
    ## Homebrew is keg-only hence versioned hence a brittle dynamic
    ## library dependency.  Prefer disabling ODBC until the `odbc`
    ## application supports linking to unixODBC (ref
    ## http://bugs.erlang.org/browse/ERL-121 ).
    configure_options_7228e3e_all_but_hipe_and_odbc: "--enable-threads --enable-dirty-schedulers --enable-new-purge-strategy --enable-smp-support --enable-lock-checking --enable-lock-counter --enable-kernel-poll --enable-sctp --disable-hipe --enable-fp-exceptions --enable-vm-probes --disable-saved-compile-time --enable-sharing-preserving --enable-m64-build --enable-sanitizers=address --disable-silent-rules --with-dynamic-trace=dtrace --with-microstate-accounting=extra --with-ets-write-concurrency-locks=256 --with-clock-resolution=high --with-javac --with-ssl={{ openssl_prefix }} --without-odbc"
    configure_options_default_w_ssl_wo_odbc: "--with-ssl={{ openssl_prefix }} --without-odbc"
    git_builds:
      git-7228e3e-all-options-but-hipe-and-odbc: ## Recent master.
        version: "7228e3e"
        url: "{{ otp_git_url }}"
        cflags: "{{ cflags_osx }}"
        configure_options: "{{ configure_options_7228e3e_all_but_hipe_and_odbc }}"
        name: git-7228e3e-all-options-but-hipe-and-odbc
      OTP-19.1: ## Latest OTP 19 point release.
        version: "OTP-19.1"
        url: "{{ otp_git_url }}"
        cflags: "{{ cflags_osx }}"
        configure_options: "{{ configure_options_default_w_ssl_wo_odbc }}"
        name: OTP-19.1
      OTP-18.3.4.4: ## Latest OTP 18 point release.
        version: "OTP-18.3.4.4"
        url: "{{ otp_git_url }}"
        cflags: "{{ cflags_osx }}"
        configure_options: "{{ configure_options_default_w_ssl_wo_odbc }}"
        name: OTP-18.3.4.4
      OTP-17.5.6.9: ## Latest OTP 17 point release.
        version: "OTP-17.5.6.9"
        url: "{{ otp_git_url }}"
        cflags: "{{ cflags_osx }}"
        configure_options: "{{ configure_options_default_w_ssl_wo_odbc }}"
        name: OTP-17.5.6.9
      ##   Dialyzer in OTP 17.3 has known issue
      ##   (197a846-17.3-w-dialyzer-fix-for-warnings_as_errors).
      ##
      ## OTP_R16B03-1 ## Latest OTP 16 point release.
      ##
      ##   For OTP [< R16B01](https://github.com/erlang/otp/commit/03ad5ea) use
      ##   [option re file descriptors](https://github.com/Homebrew/homebrew/issues/6143)

  tasks:

    - file:
        path={{ install_dir }}
        state=directory

    - include:
        kerl_build_git_and_install.yml
        cflags={{ git_builds[git_build_id].cflags }}
        kerl_configure_options={{ git_builds[git_build_id].configure_options }}
        osx_developer_mode_required={{ git_builds[git_build_id].configure_options | search("--enable-sanitizers.*address") }}
        git_url={{ git_builds[git_build_id].url }}
        git_version={{ git_builds[git_build_id].version }}
        build_name={{ git_builds[git_build_id].name }}

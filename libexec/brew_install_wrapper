#!/bin/bash -e

## Using `bash` and not `sh` for non-POSIX `local`.

## Copyright (C) 2015 Luca Favatella <slackydeb@gmail.com>

log() {
    echo "[$(basename $0)] ${1:?}"
}

log_e() {
    log "${1:?}" >&2
}

brew_unofficial_taps() {
    brew tap | grep -v -e "$(brew tap --list-official)"
}

brew_cleanup() {
    local C; C=$(brew cleanup -s 2>&1) || { log_e "'brew cleanup -s' failed. Exiting. Info:"$'\n'"$C"; exit 1; }
    local CC; CC=$(brew cask cleanup 2>&1) || { log_e "'brew cask cleanup' failed. Exiting. Info:"$'\n'"$CC"; exit 1; }
}

brew_doctor() {
    local D; D=$(brew doctor 2>&1) || { log_e "'brew doctor' detected potential problems. Continuing. Info:"$'\n'"$D"; }
    local CD; CD=$(brew cask doctor 2>&1) || { log_e "'brew cask doctor' detected potential problems. Exiting. Info:"$'\n'"$CD"; exit 1; }
}

BREW_INSTALL1="${1:?}" ## Mandatory.
BREW_INSTALL2="${2:?}" ## Mandatory.

brew uninstall --force brew-cask ## TODO Delete in July 2017. Ref https://github.com/caskroom/homebrew-cask/blob/1cabcbbf6ac6b2c1ea23920cbc388d108b11c0e3/README.md#important-december-2015-update-homebrew-cask-will-now-be-kept-up-to-date-together-with-homebrew-see-15381-for-details-if-you-havent-yet-run-brew-uninstall---force-brew-cask-brew-update-to-switch-to-the-new-system

brew update ## Synonym of `brew cask update`. Ref https://github.com/caskroom/homebrew-cask/blob/v0.56.0/doc/src/brew-cask.1.md#commands
log_e "Detected unofficial taps. Continuing. Info:"$'\n'"$(brew_unofficial_taps)" ## TODO Show only if there are any.
brew upgrade

sh -c "$BREW_INSTALL1"
sh -c "$BREW_INSTALL2"

brew_cleanup
brew_doctor
